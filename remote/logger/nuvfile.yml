# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

version: '3'

vars:
  BASEDIR: /tmp/nuvops
  HOSTNAME:
    sh: hostname

tasks:

  prereq:
    silent: true
    cmds:
    - test -n "$NUV_REMOTE_CLOUD" || die "select current cloud with 'select' subcommand"
    - test -n "$NUV_REMOTE_NTFY_TOPIC_IN" || die "configure NUV_REMOTE_NTFY_TOPIC_IN"
    - test -n "$NUV_REMOTE_NTFY_TOPIC_OUT" || die "configure NUV_REMOTE_NTFY_TOPIC_OUT"
    - test -n "$NUV_REMOTE_NTFY_TOKEN" || die "configure NUV_REMOTE_NTFY_TOKEN"
 
  run:
    silent: true
    desc: reply logger
    cmds:
    - task: prereq
    - echo "*** logger ***"
    - echo 0 >_curr
    - |
      export NTFY_TOKEN="$NUV_REMOTE_NTFY_TOKEN"
      ntfy sub "$NUV_REMOTE_NTFY_TOPIC_OUT" "nuv remote logger handle_message"

  handle_message:
    desc: react on messages using the firt tag
    silent: true
    cmds:
    #- echo "$NTFY_RAW" | jq .
    - task: on_{{.TAG}}
    vars:
      TAG:
        sh: echo "$NTFY_TAGS"
  
  on_JOIN:
    silent: true
    cmds:
    - echo "JOIN:" "$NTFY_TITLE"
    - echo "0" >"$NUV_TMP/olaris-ops.curr"
    - echo "1" >"$NUV_TMP/olaris-ops.last"
    - nuv remote logger configure HOST="$NTFY_TITLE"

  on_upload:
    silent: true

  on_command:
    silent: true

  on_UPLOAD:
    silent: true
    cmds:
    - nuv remote client refresh >/dev/null
    - echo "UPLOAD:" "$NTFY_TITLE $NTFY_MESSAGE"
    - nuv remote logger configure HOST="$NTFY_TITLE"

  on_LOG:
    silent: true
    #desc: log one entry
    cmds:
    - |
      TIMEID=$(echo $NTFY_TITLE | awk '{print $1}')
      if ! test "$(cat _curr)" = "$TIMEID"
      then echo "======================================"
           echo "$TIMEID" >_curr
      fi
    #- echo "$NTFY_RAW" | jq .
    - |
      URL="$(echo "$NTFY_RAW" | jq -r .attachment.url)"
      #echo $URL
      echo "$NTFY_TITLE"
      if test "$URL" != "null"
      then curl "$URL"
           echo "=== EOF ==="
      else echo "$NTFY_MESSAGE"
      fi  

  configure:
    silent: true
    requires:
      vars:
      - HOST
    vars:
      CLOUD:
        sh: echo $NUV_REMOTE_CLOUD
      ENVS: 
        sh: ls $NUV_PWD/env/$NUV_REMOTE_CLOUD/*.json
    cmds:
    - for: { var: ENVS, as: ENV }
      cmd: |
        FILE="{{.ENV}}"
        ENV="${FILE%%.*}"
        if test "$ENV" = "all"
        then ENV=""
        fi
        HOSTSEL=$(echo $ENV | awk -F- '{
          if($1 == "") $1="*";
          if($2 == "") $2="*";
          if($3 == "") $3="*";
          if($4 == "") $4="{{.CLOUD}}";
          print $1 "-" $2 "-" $3 "-" $4
        }')
        #echo $HOSTSEL
        FULLFILE="$NUV_PWD/env/$NUV_REMOTE_CLOUD/$FILE"
        if [[ {{.HOST}} == $HOSTSEL ]]
        then nuv remote logger setvars FILE="$FULLFILE" HOST="{{.HOST}}"
        fi

  setvars:
    silent: true
    requires:
      vars:
      - FILE
      - HOST
    vars:
      VALVARS:
        sh: jq -r 'to_entries[] | "VAR=\(.key) VAL_B64=\(.value | @base64)"' {{.FILE}}
    cmds:
    - for: { var: VALVARS, as: VALVAR, split: '\n' }
      cmd: |
          #echo "#{{.FILE}}"
          echo "{{.VALVAR}}" | awk '{print "SETVAR: {{.HOST}} " $1}'
          echo nuv remote client shell {{.HOST}} nuv remote setvar {{.VALVAR}}
